# OrigamiPost 折り紙折り動作実装方針

## 概要

Three.js を使用して折り紙の折り動作を再現するコンポーネント。ユーザーのドラッグ操作から折り線の計算、実際の折り動作までを段階的に実装する。

## 実装手順

### 1. ユーザー操作（ドラッグ&ドロップ）

**目的**: ユーザーが折り紙の頂点をドラッグして、折りたい方向を指定する

**実装内容**:

- Three.js の PlaneGeometry で作成した正方形の板（折り紙）を表示 ✅
- 各頂点にドラッグ可能なマーカー（赤い点）を配置 ✅
- マウス/タッチイベントでドラッグ操作を検知 ✅
- ドラッグ中の視覚的フィードバック（頂点の移動） ✅

**現在の実装状況**:

- 基本的なドラッグ&ドロップ機能は実装済み ✅
- ドラッグ中の点の移動は正常に動作 ✅
- 折り線計算への橋渡し処理を実装予定

**技術的詳細**:

**アーキテクチャ**:

- `useDragDrop`: ドラッグ&ドロップ機能の統合管理
  - `useInitialRender`: 折り紙とスナップポイントの初期描画
  - `useDragHandler`: ドラッグ開始・移動処理
  - `useDropHandler`: ドラッグ終了処理

**責務分担**:

1. **初期描画（useInitialRender）**

   - 折り紙の板（PlaneGeometry）をシーンに配置
   - 4 つの頂点にスナップポイント（青い球体）を配置
   - ドラッグ中の点は描画から除外

2. **ドラッグ処理（useDragHandler）**

   - マウスダウン時にレイキャスターでスナップポイントとの交差を検出
   - ドラッグ開始時に点を赤色で表示
   - マウス移動時に地面との交差で点の位置を更新

3. **ドロップ処理（useDropHandler）**
   - マウスアップ時にドラッグ状態をリセット
   - ドラッグ中の点をシーンから削除
   - シーンを再描画

**状態管理**:

- `draggedPoint`: 現在ドラッグ中の頂点の座標
- `isDragging`: ドラッグ状態のフラグ

### 2. 折り線の計算

**目的**: ドラッグ操作から折り線の位置と方向を数学的に計算する

**実装状況**: 🔄 実装予定

**計算ロジック**:

- ドラッグ前の頂点位置: `P1(x1, y1, z1)`
- ドラッグ後の頂点位置: `P2(x2, y2, z2)`
- ドラッグ方向ベクトル: `V = P2 - P1`
- 折り線は`V`の法線（垂直線）として計算

**実装方針**:

1. **データ取得**: ドラッグ終了時に元の位置と最終位置を取得
2. **ベクトル計算**: ドラッグ方向ベクトルを計算
3. **法線計算**: ドラッグ方向の法線を折り線の方向として決定
4. **折り線定義**: 折り線の開始点、終了点、方向ベクトルを計算

**必要なフック**:

- `useFoldCalculation`: 折り線計算のロジック
- ドラッグ終了時のコールバック処理

### 3. 折り紙の折り動作

**目的**: 計算された折り線に基づいて折り紙を実際に折る

**実装状況**: 🔄 実装予定

**実装方針**:

1. **板の分割**: 折り線で折り紙を 2 つの部分に分割
2. **回転の計算**: 折り線を軸として一方の部分を回転
3. **視覚的表現**: 折られた状態を Three.js で再現

**技術的アプローチ**:

1. **ジオメトリ分割**

   - 折り線に基づいて PlaneGeometry を 2 つの部分に分割
   - 各部分を独立した Mesh として作成

2. **回転処理**

   - 折り線を軸として一方の部分を 180 度回転
   - Three.js の`rotateOnAxis`を使用

3. **シーン更新**
   - 元の折り紙を非表示
   - 分割された 2 つの部分を表示

**必要なフック**:

- `useOrigamiFolding`: 折り紙の折り動作の管理
- `geometryUtils`: ジオメトリの分割処理

## コンポーネント構成

### メインコンポーネント

- `OrigamiPost`: 折り紙折り動作のメインコンポーネント
- Three.js のシーン管理、イベント処理、状態管理を担当

### カスタムフック（実装状況）

**✅ 実装済み**:

- `useDragDrop`: ドラッグ&ドロップ操作の管理
  - `useInitialRender`: 折り紙とスナップポイントの初期描画
  - `useDragHandler`: ドラッグ開始・移動処理
  - `useDropHandler`: ドラッグ終了処理

**🔄 実装予定**:

- `useFoldCalculation`: 折り線計算のロジック
- `useOrigamiFolding`: 折り紙の折り動作の管理
- `useInitScene`: Three.js シーンの初期化

### ユーティリティ関数（実装予定）

- `geometryUtils`: ジオメトリの分割、変形に関する関数
- `mathUtils`: ベクトル計算、角度計算などの数学関数
- `foldUtils`: 折り線計算、回転計算などの折り紙特有の関数

## 状態管理

**現在の実装**:

```typescript
// ドラッグ状態（実装済み）
const [draggedPoint, setDraggedPoint] = useState<Point | null>(null);
const [isDragging, setIsDragging] = useState(false);
```

**将来の拡張予定**:

```typescript
interface OrigamiState {
  // 折り紙の状態
  origami: {
    geometry: PlaneGeometry;
    material: Material;
    mesh: Mesh;
  };

  // ドラッグ状態（現在実装済み）
  drag: {
    isDragging: boolean;
    draggedPoint: Point | null;
    originalPosition: Point | null;
    finalPosition: Point | null;
  };

  // 折り線状態（実装予定）
  foldLine: {
    isCalculated: boolean;
    line: FoldLine | null;
    visualLine: Line | null;
  };

  // 折り状態（実装予定）
  folded: {
    isFolded: boolean;
    leftPart: Mesh | null;
    rightPart: Mesh | null;
    foldAngle: number;
  };
}
```

## パフォーマンス考慮事項

1. **ジオメトリの最適化**: 不要な頂点の削除、LOD（Level of Detail）の実装
2. **イベント処理の最適化**: ドラッグ中のフレームレート維持
3. **メモリ管理**: 不要なジオメトリやマテリアルの適切な破棄
4. **アニメーション**: 折り動作のスムーズなアニメーション実装

## 今後の拡張予定

1. **複数回の折り**: 一度折った折り紙をさらに折る機能
2. **折り線の可視化**: 折り線の表示/非表示切り替え
3. **折り紙のリセット**: 初期状態への復帰機能
4. **折りパターンの保存**: 折り方の保存・読み込み機能
5. **物理演算**: より現実的な折り紙の物理特性の再現
